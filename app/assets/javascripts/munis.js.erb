$(document).ready(function(){

  var elements = ["range_smell", "range_driver", "range_clean"];

  for (var i = 0, len = elements.length; i < len; i++) {
    var getHandler = function(element) {
      return function (e) {
        element.value = Math.round(element.value);
      };
    }
    var elem = document.getElementById(elements[i]);
    elem.addEventListener("mouseup", getHandler(elem), false);
    elem.addEventListener("touchend", getHandler(elem), false);
  }

  var options = {
    enableHighAccuracy: true,
    timeout: 5000,
    maximumAge: 0
  };

  function success(pos) {
    var crd = pos.coords;
    compareBusData(crd);
  };

  function error(err) {
    console.warn('ERROR(' + err.code + '): ' + err.message);
  };

  var compareBusData = function(coords){
    $.ajax({
      url: "http://proximobus-1135.appspot.com/agencies/sf-muni/vehicles.json",
    }).done(function(data){
      var vehicles = data.items;
      vehicles.sort(function(a, b){
        return distanceBetweenPoints(a, coords) - distanceBetweenPoints(b, coords);
      });
      if (distanceBetweenPoints(vehicles[0], coords) < 0.003) {
        $('#route_name_tag').text(vehicles[0].route_id);
        $('#route_name').val(vehicles[0].route_id);
        getAverages(vehicles[0]);
      };
    });

  }

  var distanceBetweenPoints = function(a, b) {
    return Math.sqrt(Math.pow((a.latitude - b.latitude), 2) + Math.pow((a.longitude - b.longitude), 2));
  };

  var getAverages = function(name){
    if (!(typeof name === "undefined")) {
      $.ajax({
        url: '/munis/' + name.route_id + '/average'
      }).done(function(content){
        if (!(content === null)) {
          <% image_names = [] %>  
          <% ["Driver", "Smell", "Clean"].each {|attr| 5.times{|num| image_names.push("#{attr}_0#{num + 1}.png")} } %>
          var imagePaths = <%= image_names.map{|img| asset_path "#{img}"} %>;
          $('#driver-score').prepend('<img id="Driver_img" src=' + imagePaths[content.avg_driver_rating - 1] + ' />');
          $('#smell-score').prepend('<img id="Smell_img" src=' + imagePaths[content.avg_smell_rating + 5 - 1] + ' />');
          $('#clean-score').prepend('<img id="Clean_img" src=' + imagePaths[content.avg_clean_rating + 10 - 1] + ' />');
        };
      });
    };
  };
  navigator.geolocation.getCurrentPosition(success, error, options);

});
